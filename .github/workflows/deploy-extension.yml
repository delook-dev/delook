name: Deploy-Chrome-Extension

on:
  push:
    branches:
      - production

# ë²„ì „ í™˜ê²½ ë³€ìˆ˜ - prefix: major.minor.patch (ìë™ìœ¼ë¡œ patchë§Œ ì¦ê°€ë¨)
env:
  MAJOR: 1
  MINOR: 0
  PATCH: 1

jobs:
  build:
    name: Build Chrome Extension
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
      - name: Checkout Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # manifest.jsonì˜ ë²„ì „ì„ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (build ë²ˆí˜¸ë§Œ ì¦ê°€)
      - name: Auto bump manifest version + version_name
        run: |
          current=$(jq -r '.version' public/manifest.json)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$current"

          NEXT_PATCH=$((PATCH + 1))

          today=$(date "+%Y.%m.%d")

          version="$MAJOR.$MINOR.$NEXT_PATCH"
          version_name="$version ($today)"

          echo "ğŸ“¦ Bumping version to $version"
          jq ".version = \"$version\" | .version_name = \"$version_name\"" public/manifest.json > tmp.json && mv tmp.json public/manifest.json

      # manifest.jsonì˜ versionì„ package.jsonì—ë„ ë™ê¸°í™”
      - name: Sync version from manifest.json to package.json
        run: |
          VERSION=$(jq -r '.version' public/manifest.json)
          echo "Syncing version to package.json: $VERSION"
          jq ".version = \"$VERSION\"" package.json > tmp.json && mv tmp.json package.json

      # ë¹Œë“œ ì‹¤í–‰
      - name: Build project
        run: yarn build

      # ë¹Œë“œëœ dist + manifest.json ì••ì¶•
      - name: Archive dist folder into zip
        run: zip -r chrome-extension-${{ github.sha }}.zip dist

      # zip íŒŒì¼ì„ GitHub Actions artifactë¡œ ì—…ë¡œë“œ (ë‹¤ìŒ jobì—ì„œ ì‚¬ìš©)
      - name: Upload zip as artifact
        uses: actions/upload-artifact@v4
        with:
          name: chrome-extension
          path: chrome-extension-${{ github.sha }}.zip

  upload:
    name: Upload to Chrome Web Store
    runs-on: ubuntu-latest
    needs: build

    strategy:
      matrix:
        node-version: [20.x]

    env:
      EXTENSION_ID: ${{ secrets.EXTENSION_ID }}

    steps:
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      # ì• ë‹¨ê³„ì—ì„œ ì—…ë¡œë“œí•œ artifact ë‹¤ìš´ë¡œë“œ
      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: chrome-extension

      # Chrome Web Store CLI ì„¤ì¹˜
      - name: Install chrome-webstore-upload-cli
        run: yarn global add chrome-webstore-upload-cli

      # í™•ì¥ í”„ë¡œê·¸ë¨ ì—…ë¡œë“œ
      - name: Upload extension zip
        run: |
          ZIP_FILE=$(ls *.zip)
          chrome-webstore-upload upload \
            --source $ZIP_FILE \
            --extension-id ${{ secrets.EXTENSION_ID }} \
            --client-id ${{ secrets.CI_GOOGLE_CLIENT_ID }} \
            --client-secret ${{ secrets.CI_GOOGLE_CLIENT_SECRET }} \
            --refresh-token ${{ secrets.CI_GOOGLE_REFRESH_TOKEN }}

      # ì—…ë¡œë“œ í›„ Web Storeì— ê²Œì‹œ(publish)
      - name: Publish extension
        run: |
          chrome-webstore-upload publish \
            --extension-id ${{ secrets.EXTENSION_ID }} \
            --client-id ${{ secrets.CI_GOOGLE_CLIENT_ID }} \
            --client-secret ${{ secrets.CI_GOOGLE_CLIENT_SECRET }} \
            --refresh-token ${{ secrets.CI_GOOGLE_REFRESH_TOKEN }}
